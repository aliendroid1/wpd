<head>        
    <script src="writeHeaderData.js"></script>
    <title>WPD Resource Hub</title>
</head>
<body>
    <script src="writeNavbar.js"></script>

    <h1 class="text-center">link upload</h1>
    <div class="alert alert-success" id="success-alert" style="display:none">
        <button type="button" class="close" data-dismiss="alert">x</button>
        <span id="message"></span>
      </div>
      <div class="alert alert-danger" id="danger-alert" style="display:none">
        <button type="button" class="close" data-dismiss="alert">x</button>
        <span id="message"></span>
      </div>
    <div class="container mt-3">
        <label>Departments:      </label><select class="form-control" id="departments">
            </select>
        <label>Title:      </label><input type="text"   class="form-control" id="link-name">
        <label>link     :      </label><input type="url"   class="form-control" id="link">
        <label>Document Name     :      </label><input type="text" class="form-control" id="docName">
        <label>Image/PDF     :      </label><input type="file" class="form-control" onchange="return fileValidation()" id="file">
        <!-- -->
        <br>
        <p class="text-danger text-center" id="submit-warning">You must be signed in to submit a form!</p>
        <div class="d-flex justify-content-center"><button type="button" class="btn btn-warning" id="form-submit-button" onclick="submitForm()" disabled>Submit</button></div>
        <br>
    </div>
   
    <script>
        firebase.auth().onAuthStateChanged(function(user) 
        {
            console.log('USer');
            if(user)
            {
                var snapshot = firebase.firestore().collection('Department').get();
                document.getElementById('submit-warning').style.display = "none";
                document.getElementById('form-submit-button').disabled = false;
                getDeparts();
            }
            else
            {
                document.getElementById('form-submit-button').disabled = true;
            }
        });
        
    
        function getDeparts(){
            firebase.auth().onAuthStateChanged(function(user) 
            {
                var select = document.getElementById("departments");
                var option = document.createElement('option');
                        option.text = "Select Department";
                        option.value = "";
                        select.add(option, 0);
                firebase.firestore().collection("Department")
                .orderBy("Department_name", "desc")
                .get()
                .then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        var option = document.createElement('option');
                        option.text = doc.data().Department_name;
                        option.value = doc.id;
                        select.add(option, 0);
                    });
                })
                .catch((e) => {
                    console.log(e);
                });

                   
                
            });
        }
        function submitForm()
        {
            firebase.auth().onAuthStateChanged(function(user) 
            {
                if(user)
                {
                    firebase.firestore().collection("upload_resources")
                        .add({
                            department      : document.getElementById("departments").value,
                            title           : document.getElementById("link-name").value,
                            url             : document.getElementById("link").value,
                            document_name   : document.getElementById("docName").value,
                        })
                        .then(() => {
                            console.log("Document updated"); // Document updated
                            $('#message').html('Resource added successfully');
                            $("#success-alert").show(1000);
                            setTimeout(function() {
                                $("#success-alert").hide(1000);
                            }, 4000);
                        })
                        .catch((error) => {
                            console.error("Error updating doc", error);
                            $('#message').html('Failed to add resource');
                            $("#danger-alert").show(1000);
                            setTimeout(function() {
                                $("#danger-alert").hide(1000);
                            }, 4000);
                        });
                 }
            });
           
        }
        function fileValidation() {
            var fileInput = 
                document.getElementById('file');
              
            var filePath = fileInput.value;
          
            var allowedExtensions = /(\.jpg|\.jpeg|\.png|\.gif|\.pdf)$/i;
              
            if (!allowedExtensions.exec(filePath)) {
                alert('Invalid file type');
                fileInput.value = '';
                return false;
            } else {
            }
        }
        function uploadimage(){
            var storage = firebase.storage();
            var file=document.getElementById("file").files[0];
            var storageref=storage.ref();
            var thisref=storageref.child(file.name).put(file);
            thisref.on('state_changed',function(snapshot) {


            }, function(error) {

            }, function() {
            thisref.snapshot.ref.getDownloadURL().then(function(downloadURL) {
                document.getElementById("url").value=downloadURL;
                alert('uploaded successfully');
                saveMessage(downloadURL);
            });
            });
        }
        function getInputVal(id){
        return document.getElementById(id).value;
        }
  </script>
</body>
</html>